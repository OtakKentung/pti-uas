/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/Logger","../../../../../../symbols/cim/cimAnalyzer","../../../../../../symbols/cim/utils","./WGLMeshTemplate"],(function(e,t,a,i,n){"use strict";const r=t.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");return function(t){function n(e){var a;return(a=t.call(this)||this)._ongoingMaterialRequestMap=new Map,a._materialCache=new Map,a._dynamicPropertyMap=new Map,a._cimLayer=e,a}return e._inheritsLoose(n,t),n.prototype.analyze=function(e,t,n,s,l){const o=t.readLegacyFeature(),u=this._materialCache,c=this._cimLayer.materialHash;if(!c)return r.error("A Dynamic mesh template must have a material hash value or function!"),Promise.reject(null);const m="function"==typeof c?c(o,n,s):c;if(u.has(m)){const e=u.get(m);return Promise.resolve(e)}if(this._ongoingMaterialRequestMap.has(m))return this._ongoingMaterialRequestMap.get(m);const h=this._cimLayer,g=a.analyzeCIMResource(h.cim,this._cimLayer.materialOverrides),{type:p,url:M}=h,y={cim:g,type:p,mosaicHash:m,url:M,size:null,dashTemplate:null,text:null,fontName:null};switch(p){case"marker":y.size=i.evaluateValueOrFunction(h.size,o,n,s);break;case"line":y.dashTemplate=h.dashTemplate;break;case"text":y.text=i.evaluateValueOrFunction(h.text,o,n,s),y.fontName=i.evaluateValueOrFunction(h.fontName,o,n,s)}const _=e.getMosaicItem(y,l).then((e=>(this._ongoingMaterialRequestMap.delete(m),u.set(m,e),e))).catch((e=>(this._ongoingMaterialRequestMap.delete(m),r.error(".analyze()",e.message),null)));return this._ongoingMaterialRequestMap.set(m,_),_},n}(n)}));
